name: Branch Retention Check

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  calculate-retention:
    runs-on: ubuntu-latest
    outputs:
      branches-to-remove: ${{ steps.calculate.outputs.branches-to-remove }}
      total-branches-to-retain: ${{ steps.calculate.outputs.total-retained }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate retention strategy
        id: calculate
        run: |
          # Fetch all release branches sorted by date (newest first)
          git fetch --all
          ALL_BRANCHES=$(git for-each-ref --sort=-committerdate --format="%(refname:short)" refs/remotes/origin/release/ | sed 's/origin\///')
          
          # Find the 4th newest standard format branch as cutoff point
          CUTOFF_BRANCH=$(echo "$ALL_BRANCHES" | grep -E '^release/[0-9]+\.[0-9]+\.[0-9]+$' | head -4 | tail -1)
          
          if [ -n "$CUTOFF_BRANCH" ]; then
            CUTOFF_DATE=$(git log -1 --format="%ct" "origin/$CUTOFF_BRANCH")
            BRANCHES_TO_REMOVE=""
            RETAINED_COUNT=0
            
            for branch in $ALL_BRANCHES; do
              BRANCH_DATE=$(git log -1 --format="%ct" "origin/$branch" 2>/dev/null || echo "0")
              if [ "$BRANCH_DATE" -ge "$CUTOFF_DATE" ]; then
                RETAINED_COUNT=$((RETAINED_COUNT + 1))
              else
                BRANCHES_TO_REMOVE="$BRANCHES_TO_REMOVE$branch "
              fi
            done
          else
            # Fallback: if no standard branches found, retain all
            BRANCHES_TO_REMOVE=""
            RETAINED_COUNT=$(echo "$ALL_BRANCHES" | wc -l)
          fi
          
          # Clean up and format output
          BRANCHES_TO_REMOVE=$(echo "$BRANCHES_TO_REMOVE" | tr ' ' '\n' | grep -v '^$')
          
          echo "branches-to-remove=$(echo "$BRANCHES_TO_REMOVE" | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
          echo "total-retained=$RETAINED_COUNT" >> $GITHUB_OUTPUT
          
          echo "Branches to remove: $(echo "$BRANCHES_TO_REMOVE" | tr '\n' ' ')"
          echo "Total branches to retain: $RETAINED_COUNT"

      - name: Display results
        run: |
          echo "Branches to remove: ${{ steps.calculate.outputs.branches-to-remove }}"
          echo "Total branches to retain: ${{ steps.calculate.outputs.total-retained }}"

  # Example job that uses the retention data
  cleanup-example:
    needs: calculate-retention
    runs-on: ubuntu-latest
    if: false  # Set to true to enable this example job
    
    steps:
      - name: Use retention data
        run: |
          echo "Branches to remove: ${{ needs.calculate-retention.outputs.branches-to-remove }}"
          echo "Total branches to retain: ${{ needs.calculate-retention.outputs.total-branches-to-retain }}"