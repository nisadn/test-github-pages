name: Release Branch Cleanup

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 2 * * 1' # Run weekly on Monday at 2 AM UTC

jobs:
  cleanup-release-branches:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetch all branches and history
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Process Release Branches
      id: process-branches
      run: |
        echo "Processing release branches..."
        
        # Get all release branches sorted by creation date (oldest first)
        release_branches=$(git for-each-ref --format='%(refname:short) %(creatordate)' refs/remotes/origin/release/ | sort -k2 | awk '{print $1}' | sed 's|origin/||')
        
        # Convert to array
        readarray -t branches_array <<< "$release_branches"
        
        # Initialize arrays
        retained_branches=()
        removed_branches=()
        count=0
        
        # Standard format regex for release/X.Y.Z
        standard_format_regex="^release/[0-9]+\.[0-9]+\.[0-9]+$"
        
        echo "Found release branches (oldest first):"
        for branch in "${branches_array[@]}"; do
          if [[ -n "$branch" ]]; then
            echo "  $branch"
          fi
        done
        
        # Process branches from newest to oldest (reverse the array)
        for ((i=${#branches_array[@]}-1; i>=0; i--)); do
          branch="${branches_array[i]}"
          
          # Skip empty lines
          if [[ -z "$branch" ]]; then
            continue
          fi
          
          # Check if we should retain this branch
          if [[ $count -lt 4 ]]; then
            # Check if it follows standard format
            if [[ $branch =~ $standard_format_regex ]]; then
              retained_branches+=("$branch")
              ((count++))
              echo "✅ Retaining: $branch (standard format, count: $count)"
            else
              retained_branches+=("$branch")
              echo "✅ Retaining: $branch (non-standard format, but within limit)"
            fi
          else
            # Add to removal list
            removed_branches+=("$branch")
            echo "❌ Marking for removal: $branch"
          fi
        done
        
        # Output results
        echo ""
        echo "=== SUMMARY ==="
        echo "Branches to retain (${#retained_branches[@]}):"
        for branch in "${retained_branches[@]}"; do
          echo "  ✅ $branch"
        done
        
        echo ""
        echo "Branches to remove (${#removed_branches[@]}):"
        for branch in "${removed_branches[@]}"; do
          echo "  ❌ $branch"
        done
        
        # Set outputs for use in subsequent steps
        {
          echo "retained_branches<<EOF"
          printf '%s\n' "${retained_branches[@]}"
          echo "EOF"
        } >> $GITHUB_OUTPUT
        
        {
          echo "removed_branches<<EOF"
          printf '%s\n' "${removed_branches[@]}"
          echo "EOF"
        } >> $GITHUB_OUTPUT
        
        echo "retained_count=${#retained_branches[@]}" >> $GITHUB_OUTPUT
        echo "removed_count=${#removed_branches[@]}" >> $GITHUB_OUTPUT
    
    - name: Create Summary
      run: |
        echo "## Release Branch Cleanup Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Branches to Retain (${{ steps.process-branches.outputs.retained_count }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.process-branches.outputs.retained_count }}" -gt 0 ]]; then
          echo "| Branch | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          while IFS= read -r branch; do
            if [[ -n "$branch" ]]; then
              if [[ $branch =~ ^release/[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                echo "| \`$branch\` | ✅ Standard format |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| \`$branch\` | ⚠️ Non-standard format |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done <<< "${{ steps.process-branches.outputs.retained_branches }}"
        else
          echo "*No branches to retain*" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Branches Marked for Removal (${{ steps.process-branches.outputs.removed_count }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.process-branches.outputs.removed_count }}" -gt 0 ]]; then
          echo "| Branch |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|" >> $GITHUB_STEP_SUMMARY
          while IFS= read -r branch; do
            if [[ -n "$branch" ]]; then
              echo "| \`$branch\` |" >> $GITHUB_STEP_SUMMARY
            fi
          done <<< "${{ steps.process-branches.outputs.removed_branches }}"
        else
          echo "*No branches to remove*" >> $GITHUB_STEP_SUMMARY
        fi
    
    # Uncomment the following step if you want to actually delete the branches
    # - name: Delete Old Release Branches
    #   if: steps.process-branches.outputs.removed_count > 0
    #   run: |
    #     echo "Deleting old release branches..."
    #     while IFS= read -r branch; do
    #       if [[ -n "$branch" ]]; then
    #         echo "Deleting branch: $branch"
    #         git push origin --delete "$branch" || echo "Failed to delete $branch (might not exist on remote)"
    #       fi
    #     done <<< "${{ steps.process-branches.outputs.removed_branches }}"